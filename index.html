<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Komik Reader</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#111;color:#fff}
button{cursor:pointer}

/* SEARCH */
.search-wrap{padding:12px;background:#181818}
.search-box{position:relative}
.search-box input{
  width:100%;padding:12px 42px 12px 14px;
  border-radius:25px;border:none;
  background:#2a2a2a;color:#fff
}
.search-action{
  position:absolute;right:6px;top:50%;
  transform:translateY(-50%) scale(.8);
  display:flex;gap:6px;
  opacity:0;pointer-events:none;transition:.25s
}
.search-action.show{opacity:1;transform:translateY(-50%) scale(1);pointer-events:auto}
.search-action button{width:32px;height:32px;border-radius:50%;border:none}

/* NAV */
.nav{display:flex;position:relative;background:#181818}
.nav button{flex:1;padding:14px;background:none;border:none;color:#aaa;font-weight:bold}
.nav button.active{color:#fff}
.nav-indicator{position:absolute;bottom:0;height:3px;width:50%;background:#fff;transition:.35s}

/* CONTENT */
#content{padding:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:10px
}
.card{
  background:#1c1c1c;border-radius:8px;overflow:hidden;
  transition:.2s
}
.card:hover{transform:scale(1.03)}
.card img{width:100%;aspect-ratio:3/4;object-fit:cover}
.card .info{padding:6px;font-size:13px}

/* DETAIL */
.detail img{width:150px;border-radius:8px}
.chapters button{
  width:100%;margin:4px 0;padding:10px;
  border:none;background:#222;color:#fff;border-radius:6px
}

/* READER */
.reader img{width:100%;display:block;margin-bottom:6px}
.reader-nav{display:flex;gap:10px;margin:10px 0}
.reader-nav button{flex:1;padding:12px;border:none;border-radius:6px;background:#222;color:#fff}

/* BOOKMARK */
.bookmark-btn{
  margin:8px 0;padding:10px;
  background:#ffcc00;color:#000;border:none;border-radius:6px;font-weight:bold
}
.section-title{margin-top:20px}
</style>
</head>

<body>

<div class="search-wrap">
  <div class="search-box">
    <input id="searchInput" placeholder="Cari judul komik...">
    <div id="searchAction" class="search-action">
      <button onclick="searchManga()">üîç</button>
      <button onclick="clearSearch()">‚ùå</button>
    </div>
  </div>
</div>

<div class="nav">
  <button id="tabAll" class="active">üìö Semua</button>
  <button id="tabLatest">üÜï Terbaru</button>
  <div id="navIndicator" class="nav-indicator"></div>
</div>

<div id="content"></div>

<script>
const API="https://unofficial-komikcast-api.vercel.app";
const content=document.getElementById("content");
const searchInput=document.getElementById("searchInput");
const searchAction=document.getElementById("searchAction");
const navIndicator=document.getElementById("navIndicator");
const tabAll=document.getElementById("tabAll");
const tabLatest=document.getElementById("tabLatest");

let page=1, mode="all", loading=false, lastData=[];

/* SEARCH UX */
searchInput.oninput=e=>{
  searchAction.classList.toggle("show",e.target.value.trim());
};

/* TAB */
function setTab(tab){
  tabAll.classList.remove("active");
  tabLatest.classList.remove("active");
  tab.classList.add("active");
  navIndicator.style.transform=tab===tabAll?"translateX(0%)":"translateX(100%)";
  page=1;lastData=[];content.innerHTML="";
}
tabAll.onclick=()=>{setTab(tabAll);mode="all";loadMore();}
tabLatest.onclick=()=>{setTab(tabLatest);mode="latest";loadMore();}

/* INFINITE SCROLL */
window.onscroll=()=>{
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-300){
    loadMore();
  }
};

async function loadMore(){
  if(loading) return;
  loading=true;
  let url="";
  if(mode==="all") url=`/komikcast/${page}`;
  if(mode==="latest") url="/komikcast/latest";
  if(mode==="search") url=`/komikcast/search?q=${searchInput.value}&page=${page}`;
  const res=await fetch(API+url);
  const j=await res.json();
  const data=j.data||[];
  lastData=[...lastData,...data];
  renderGrid(lastData);
  page++;loading=false;
}

/* GRID */
function renderGrid(data){
  content.innerHTML=`<div class="grid">${
    data.map(m=>`
      <div class="card" onclick="loadDetail('${m.slug}')">
        <img loading="lazy" src="${m.thumbnail}">
        <div class="info">${m.title}</div>
      </div>`).join("")
  }</div>`;
}

/* DETAIL */
async function loadDetail(slug){
  const res=await fetch(API+"/komikcast/detail/"+slug);
  const d=(await res.json()).data;
  const bookmarked=isBookmarked(slug);
  content.innerHTML=`
    <div class="detail">
      <img src="${d.thumbnail}">
      <h2>${d.title}</h2>
      <button class="bookmark-btn" onclick="toggleBookmark('${slug}','${d.title}','${d.thumbnail}')">
        ${bookmarked?"‚òÖ Bookmarked":"‚òÜ Bookmark"}
      </button>
      <p>${d.synopsis}</p>
      <div class="chapters">
        ${d.chapters.map(c=>`
          <button onclick="loadChapter('${c.slug}','${d.title}')">${c.title}</button>`).join("")}
      </div>
    </div>`;
}

/* READER + HISTORY */
async function loadChapter(slug,title){
  const res=await fetch(API+"/komikcast/chapter/"+slug);
  const d=(await res.json()).data;
  saveHistory(title,slug);
  content.innerHTML=`
    <h3>${d.title}</h3>
    <div class="reader">
      ${d.images.map(i=>`<img loading="lazy" src="${i}">`).join("")}
    </div>
    <div class="reader-nav">
      <button ${!d.previous_chapter_slug?"disabled":""}
        onclick="loadChapter('${d.previous_chapter_slug}','${title}')">‚¨Ö Sebelumnya</button>
      <button ${!d.next_chapter_slug?"disabled":""}
        onclick="loadChapter('${d.next_chapter_slug}','${title}')">Selanjutnya ‚û°</button>
    </div>`;
}

/* SEARCH */
function searchManga(){
  if(!searchInput.value.trim())return;
  mode="search";page=1;lastData=[];content.innerHTML="";
  loadMore();
}
function clearSearch(){
  searchInput.value="";searchAction.classList.remove("show");
  setTab(tabAll);mode="all";loadMore();
}

/* BOOKMARK */
function getBookmarks(){return JSON.parse(localStorage.getItem("bm")||"[]")}
function isBookmarked(slug){return getBookmarks().some(b=>b.slug===slug)}
function toggleBookmark(slug,title,thumb){
  let bm=getBookmarks();
  bm=isBookmarked(slug)?bm.filter(b=>b.slug!==slug):[...bm,{slug,title,thumb}];
  localStorage.setItem("bm",JSON.stringify(bm));
  loadDetail(slug);
}

/* HISTORY */
function saveHistory(title,slug){
  let h=JSON.parse(localStorage.getItem("history")||"[]");
  h=[{title,slug,date:Date.now()},...h.filter(x=>x.slug!==slug)].slice(0,20);
  localStorage.setItem("history",JSON.stringify(h));
}

/* INIT */
loadMore();
</script>

</body>
</html>
